name: Scrape Tournaments

on:
  # Run daily at 6 AM UTC (1 AM EST / 2 AM EDT)
  schedule:
    - cron: '0 6 * * *'
  
  # Allow manual trigger from GitHub Actions tab
  workflow_dispatch:
  
  # Also run on push to main (for testing)
  push:
    branches:
      - main
    paths:
      - 'gvdg-tournament-scraper/scrape-tournaments.js'
      - '.github/workflows/scrape-tournaments.yml'

jobs:
  scrape:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Run scraper
        working-directory: ./gvdg-tournament-scraper
        run: node scrape-tournaments.js
        continue-on-error: true
      
      - name: Check if tournaments.json was updated
        id: check_changes
        run: |
          if [ ! -f gvdg-tournament-scraper/tournaments.json ]; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No tournaments.json file found"
          elif git diff --quiet gvdg-tournament-scraper/tournaments.json 2>/dev/null; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No changes to tournament data"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Tournament data updated!"
          fi
      
      - name: Commit and push changes
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add gvdg-tournament-scraper/tournaments.json
          git commit -m "ðŸ¥ Update tournament data - $(date +'%Y-%m-%d %H:%M UTC')"
          git push
      
      - name: Generate Summary
        run: |
          echo "## ðŸ¥ Tournament Scrape Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f gvdg-tournament-scraper/tournaments.json ]; then
            TOTAL=$(jq '.totalCount' gvdg-tournament-scraper/tournaments.json)
            GVDG=$(jq '[.tournaments[] | select(.isGVDG == true)] | length' gvdg-tournament-scraper/tournaments.json)
            UPDATED=$(jq -r '.lastUpdated' gvdg-tournament-scraper/tournaments.json)
            HAS_ERROR=$(jq -r '.error // empty' gvdg-tournament-scraper/tournaments.json)
            
            echo "- **Total Tournaments:** $TOTAL" >> $GITHUB_STEP_SUMMARY
            echo "- **GVDG Events:** $GVDG" >> $GITHUB_STEP_SUMMARY
            echo "- **Last Updated:** $UPDATED" >> $GITHUB_STEP_SUMMARY
            
            if [ -n "$HAS_ERROR" ]; then
              echo "- âš ï¸ **Note:** Using fallback data (fetch error)" >> $GITHUB_STEP_SUMMARY
            fi
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Upcoming Events (Next 10)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            jq -r '.tournaments[:10][] | "- **\(.date)** - \(.name) @ \(.city // "TBD") \(if .isGVDG then "â­" else "" end)"' gvdg-tournament-scraper/tournaments.json >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ No tournaments.json file found" >> $GITHUB_STEP_SUMMARY
          fi
